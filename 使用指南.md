# 麦轮小车键控系统 - 快速使用指南

> 💡 **ROS2版本支持**: 本系统支持Jazzy、Humble、Iron等版本。Jazzy用户请参考 [ROS2_JAZZY说明.md](ROS2_JAZZY说明.md)

## 🚀 快速开始（树莓派上）

### 第一次使用

```bash
# 1. 进入ROS2工作空间
cd ~/ros2_ws/src

# 2. 复制keyboard_control目录
# （假设你已经通过git或scp将代码传到树莓派）

# 3. 编译
cd ~/ros2_ws
colcon build --packages-select keyboard_mecanum

# 4. 加载环境
source install/setup.bash

# 5. 启动系统
ros2 launch keyboard_mecanum full_system_launch.py
```

---

## 💡 最常用的3种启动方式

### 1️⃣ 只要键控（最简单）

```bash
ros2 launch keyboard_mecanum keyboard_control_launch.py
```

**适用场景**: 手动遥控小车，不需要二维码识别

**按键说明**:
- `i` = 前进
- `,` = 后退  
- `j` = 左转
- `l` = 右转
- `a` = 左横移
- `d` = 右横移
- `1/2/3` = 控制舵机S1

---

### 2️⃣ 键控 + 二维码识别（推荐）

```bash
ros2 launch keyboard_mecanum full_system_launch.py
```

**适用场景**: 边遥控边识别二维码，识别结果自动显示

**查看识别结果**:
```bash
# 在另一个SSH终端
ros2 topic echo /qr_code
```

---

### 3️⃣ 只要二维码识别

```bash
ros2 launch keyboard_mecanum qr_scanner_launch.py
```

**适用场景**: 小车自主运动，只需要识别二维码

---

## 🎮 核心功能：长按式控制

### ✅ 这是长按模式

- **按住** `i` 键 → 小车前进
- **松开** `i` 键 → 小车立即停止
- **按住** `a` 键 → 小车左横移
- **松开** → 立即停止

### ❌ 不是按一次持续模式

开源键控是：按一次 `i` → 一直前进 → 按 `k` 停止

我们的键控是：按住 `i` → 前进 → 松开停止 ✅

---

## 🔧 常用命令

### 查看所有话题

```bash
ros2 topic list
```

**应该看到**:
```
/cmd_vel       # 小车速度控制
/servo_s1      # 舵机S1控制
/qr_code       # 二维码识别结果
```

### 监控小车速度

```bash
ros2 topic echo /cmd_vel
```

### 监控二维码识别

```bash
ros2 topic echo /qr_code
```

### 手动控制舵机

```bash
# S1转到45度
ros2 topic pub --once /servo_s1 std_msgs/msg/Int32 "{data: 45}"

# S1回中位
ros2 topic pub --once /servo_s1 std_msgs/msg/Int32 "{data: 0}"

# S1转到-45度
ros2 topic pub --once /servo_s1 std_msgs/msg/Int32 "{data: -45}"
```

---

## ⚙️ 配置修改

### 调整速度限制

编辑 `launch/keyboard_control_launch.py`:

```python
parameters=[{
    'linear_speed_limit': 1.0,      # 改成1.5可以更快
    'angular_speed_limit': 5.0,     # 改成6.0转得更快
}]
```

### 调整舵机角度

编辑 `keyboard_mecanum/keyboard_control_node.py`:

```python
# 找到这一行
servoBindings = {
    '1': -45,  # 改成 -60 可以转得更多
    '2': 0,    
    '3': 45,   # 改成 60
}
```

### 调整相机分辨率

编辑 `launch/qr_scanner_launch.py`:

```python
parameters=[{
    'camera_width': 640,    # 改成320可以更快
    'camera_height': 480,   # 改成240
    'publish_rate': 10.0,   # 改成20.0识别更频繁
}]
```

---

## 🐛 常见问题

### Q1: 启动键控提示没有termios模块

**A**: 必须在Linux（树莓派）上运行，Windows不支持。

### Q2: 二维码识别启动失败

**A**: 
```bash
# 检查相机
libcamera-hello -t 5

# 启用相机
sudo raspi-config
# -> Interface Options -> Camera -> Enable
```

### Q3: 按键无反应

**A**: 
- 检查终端是否在前台（xterm窗口需要处于激活状态）
- 按 `Ctrl+C` 退出后重新启动

### Q4: 舵机不转

**A**:
```bash
# 检查ESP32是否在线
ros2 topic list

# 手动测试
ros2 topic pub --once /servo_s1 std_msgs/msg/Int32 "{data: 0}"
```

### Q5: 横移不工作

**A**: 
- 确保ESP32固件支持麦轮（处理了`linear.y`）
- 检查发送的命令：`ros2 topic echo /cmd_vel`

---

## 📝 完整按键列表

```
移动:
  i  = 前进          ,  = 后退
  j  = 左转          l  = 右转
  u  = 左前          o  = 右前
  m  = 左后          .  = 右后
  a  = 左横移        d  = 右横移

舵机:
  1  = S1左转(-45°)
  2  = S1中位(0°)
  3  = S1右转(45°)

速度:
  q/z = 总速度 ±10%
  w/x = 线速度 ±10%
  e/c = 角速度 ±10%

停止:
  空格 或 k = 停止
  Ctrl+C = 退出
```

---

## 🎯 系统架构

```
树莓派
├── keyboard_control_node        (键控节点)
│   ├── 发布 /cmd_vel           → ESP32
│   └── 发布 /servo_s1          → ESP32
│
├── qr_scanner_node              (二维码识别)
│   └── 发布 /qr_code           → 其他节点可订阅
│
└── ESP32 (odom_publisher)
    ├── 订阅 /cmd_vel           (控制电机)
    ├── 订阅 /servo_s1          (控制舵机S1)
    ├── 订阅 /servo_s2          (控制舵机S2)
    └── 发布 /odom_raw          (里程计)
```

---

## ✅ 测试清单

启动后，依次测试：

- [ ] 按住 `i` 键，小车前进
- [ ] 松开 `i` 键，小车停止
- [ ] 按住 `a` 键，小车左横移
- [ ] 按住 `d` 键，小车右横移
- [ ] 按 `1` 键，舵机S1左转
- [ ] 按 `2` 键，舵机S1回中位
- [ ] 按 `3` 键，舵机S1右转
- [ ] 二维码放在相机前，终端显示识别结果
- [ ] 换一个二维码，终端显示新的结果

---

**🎉 所有功能已完成！祝使用愉快！**

