# 麦轮小车键控系统 - 项目说明

> 💡 **ROS2版本**: 支持 Jazzy / Humble / Iron。详见 [ROS2_JAZZY说明.md](ROS2_JAZZY说明.md)

## 📁 项目结构

```
keyboard_control/
├── keyboard_mecanum/              # ROS2包主目录
│   ├── __init__.py               # Python包初始化
│   ├── keyboard_control_node.py  # 长按式键控节点
│   └── qr_scanner_node.py        # 二维码识别节点
│
├── launch/                        # 启动文件目录
│   ├── keyboard_control_launch.py    # 仅键控
│   ├── qr_scanner_launch.py          # 仅二维码识别
│   └── full_system_launch.py         # 完整系统
│
├── resource/                      # ROS2资源文件
│   └── keyboard_mecanum          # 空标记文件
│
├── yahboomcar_ctrl_ref/          # 参考代码（开源版本）
│
├── package.xml                    # ROS2包配置文件
├── setup.py                       # Python包安装配置
├── setup.cfg                      # 安装脚本配置
│
├── README.md                      # 详细技术文档
├── 使用指南.md                    # 快速使用指南
├── 项目说明.md                    # 本文件
│
├── install.sh                     # 自动安装脚本
└── test_system.sh                 # 交互式测试脚本
```

---

## ✨ 核心功能

### 1. 长按式键控节点 (`keyboard_control_node.py`)

**特点**:
- ✅ 长按按键持续移动，松开立即停止
- ✅ 支持麦轮真正横移（a/d键）
- ✅ 集成舵机S1控制（1/2/3键）
- ✅ 实时速度调整
- ✅ 发布到 `/cmd_vel` 和 `/servo_s1` 话题

**按键布局**:
```
   u    i    o       1 2 3
   j    k    l       (舵机)
   m    ,    .
      a   d
    (横移)
```

**发布话题**:
- `/cmd_vel` (geometry_msgs/Twist) - 小车速度控制
- `/servo_s1` (std_msgs/Int32) - 舵机S1角度

---

### 2. 二维码识别节点 (`qr_scanner_node.py`)

**特点**:
- ✅ 基于树莓派相机 (`rpicam-vid`)
- ✅ 使用OpenCV进行二维码检测
- ✅ 识别结果变化时自动发布
- ✅ 可配置发布频率和相机分辨率

**发布话题**:
- `/qr_code` (std_msgs/String) - 二维码识别结果

**优化**:
- 只在识别内容变化时发布（避免重复）
- 自动对焦支持
- 优雅的资源清理

---

## 🚀 3种启动方式

### 方式1: 仅键控 (keyboard_control_launch.py)

```bash
ros2 launch keyboard_mecanum keyboard_control_launch.py
```

**适用场景**: 手动遥控

### 方式2: 仅二维码识别 (qr_scanner_launch.py)

```bash
ros2 launch keyboard_mecanum qr_scanner_launch.py
```

**适用场景**: 小车自主运动时需要识别

### 方式3: 完整系统 (full_system_launch.py)

```bash
ros2 launch keyboard_mecanum full_system_launch.py
```

**适用场景**: 边遥控边识别（推荐）

---

## 🔧 配置参数

### 键控节点参数

| 参数名 | 默认值 | 说明 |
|--------|--------|------|
| `linear_speed_limit` | 1.0 | 最大线速度 (m/s) |
| `angular_speed_limit` | 5.0 | 最大角速度 (rad/s) |

### 二维码识别参数

| 参数名 | 默认值 | 说明 |
|--------|--------|------|
| `camera_width` | 640 | 相机宽度 (像素) |
| `camera_height` | 480 | 相机高度 (像素) |
| `publish_rate` | 10.0 | 发布频率 (Hz) |

---

## 📡 ROS2话题通信

### 话题列表

| 话题名 | 消息类型 | 方向 | 说明 |
|--------|---------|------|------|
| `/cmd_vel` | `geometry_msgs/Twist` | 发布 | 小车速度控制 |
| `/servo_s1` | `std_msgs/Int32` | 发布 | 舵机S1角度 |
| `/qr_code` | `std_msgs/String` | 发布 | 二维码识别结果 |

### 消息格式

#### `/cmd_vel` (Twist)
```yaml
linear:
  x: 0.3    # 前后速度 (m/s)
  y: 0.2    # 横移速度 (m/s) - 麦轮专用
  z: 0.0
angular:
  x: 0.0
  y: 0.0
  z: 1.0    # 旋转速度 (rad/s)
```

#### `/servo_s1` (Int32)
```yaml
data: 45    # 角度 (-90 到 90)
```

#### `/qr_code` (String)
```yaml
data: "https://example.com"    # 识别到的二维码内容
```

---

## 🛠️ 安装方法

### 方法1: 使用自动安装脚本（推荐）

```bash
cd keyboard_control
chmod +x install.sh
./install.sh
```

### 方法2: 手动安装

```bash
# 1. 复制到ROS2工作空间
cd ~/ros2_ws/src
cp -r /path/to/keyboard_control ./

# 2. 安装依赖
sudo apt install python3-opencv python3-numpy xterm

# 3. 编译
cd ~/ros2_ws
colcon build --packages-select keyboard_mecanum

# 4. 加载环境
source install/setup.bash
```

---

## 🧪 测试方法

### 方法1: 使用测试脚本（推荐）

```bash
cd keyboard_control
chmod +x test_system.sh
./test_system.sh
```

### 方法2: 手动测试

```bash
# 测试键控
ros2 run keyboard_mecanum keyboard_control

# 测试二维码识别
ros2 run keyboard_mecanum qr_scanner

# 查看话题
ros2 topic list
ros2 topic echo /cmd_vel
ros2 topic echo /qr_code
```

---

## 📋 与参考代码的对比

### 开源版本 (yahboomcar_ctrl_ref)

- ❌ 按一次持续移动
- ❌ 需按k停止
- ⚠️ 模拟横移（旋转+前进）
- ❌ 舵机需单独控制
- ❌ 无二维码识别

### 本系统 (keyboard_mecanum)

- ✅ 长按移动，松开停止
- ✅ 自动停止
- ✅ 真正麦轮横移
- ✅ 集成舵机控制（1/2/3键）
- ✅ 集成二维码识别ROS2节点

---

## 🎯 硬件要求

### 必需
- 树莓派 4B 或更高版本
- ESP32-S3 (运行odom_publisher固件)
- 麦克勒姆轮小车
- 树莓派相机模块

### 可选
- 舵机S1 (连接到ESP32 GPIO 8)
- 舵机S2 (连接到ESP32 GPIO 21)

---

## 🔌 系统连接

```
树莓派                      ESP32-S3
├── USB串口 ---------> USB (MicroROS Agent)
├── 相机排线 -------> 树莓派CSI接口
└── 电源

小车底盘
├── 4个麦轮电机 ----> ESP32电机驱动
├── 舵机S1 ----------> ESP32 GPIO 8
└── 舵机S2 ----------> ESP32 GPIO 21
```

---

## 📚 文档索引

| 文档 | 用途 |
|------|------|
| `README.md` | 详细技术文档和API说明 |
| `使用指南.md` | 快速开始和常用命令 |
| `项目说明.md` | 项目结构和设计说明（本文件） |
| `odom_publisher/舵机控制说明.md` | ESP32舵机控制详解 |

---

## 🎓 学习路径

### 入门 (5分钟)
1. 阅读 `使用指南.md`
2. 运行 `install.sh`
3. 启动键控测试

### 进阶 (30分钟)
1. 阅读 `README.md`
2. 尝试所有启动方式
3. 运行 `test_system.sh` 测试所有功能

### 深入 (1小时+)
1. 阅读源代码
2. 修改参数进行实验
3. 自定义按键映射
4. 集成到自己的项目

---

## 🔍 代码亮点

### 1. 长按检测机制

```python
# 50ms超时，提高响应速度
key = self.getKey(timeout=0.05)

if key == '':
    # 没有按键 = 停止
    x = y = th = 0
```

### 2. 麦轮横移支持

```python
moveBindings = {
    'a': (0, 1, 0),   # 纯横移，y方向非零
    'd': (0, -1, 0),
}
```

### 3. 二维码去重发布

```python
if data and data != self.last_qr_data:
    self.last_qr_data = data
    self.qr_pub.publish(msg)  # 只在变化时发布
```

### 4. 优雅的资源清理

```python
def cleanup(self):
    if self.cap:
        self.cap.release()
    if self.rpicam_process:
        self.rpicam_process.terminate()
    os.unlink(self.fifo_path)
```

---

## 🚧 已知限制

1. **键控节点**: 必须在Linux终端运行（需要termios）
2. **二维码识别**: 仅支持树莓派相机（使用rpicam-vid）
3. **舵机控制**: 需要ESP32固件支持（odom_publisher）
4. **麦轮横移**: 需要ESP32固件处理linear.y参数

---

## 🔮 未来扩展

### 可能的改进方向

- [ ] 添加游戏手柄支持
- [ ] 增加图像显示功能（非SSH）
- [ ] 支持多个二维码同时识别
- [ ] 添加语音控制
- [ ] 集成SLAM导航
- [ ] Web界面控制
- [ ] 识别结果数据库记录

---

## 📞 技术支持

如遇问题，请检查：

1. **启动失败**: 查看 `使用指南.md` 的故障排查部分
2. **按键无反应**: 确保在Linux终端运行
3. **相机问题**: 运行 `libcamera-hello -t 5000` 测试
4. **话题不通**: 检查ESP32是否连接并运行MicroROS Agent

---

## ✅ 功能清单

- [x] 长按式键控
- [x] 麦轮横移
- [x] 舵机S1控制（1/2/3键）
- [x] 二维码识别
- [x] ROS2节点封装
- [x] Launch文件
- [x] 参数配置
- [x] 自动安装脚本
- [x] 测试脚本
- [x] 完整文档

---

**版本**: v1.0.0  
**创建日期**: 2024-11-22  
**测试平台**: 树莓派4B + ROS2 (Humble/Jazzy) + ESP32-S3  
**License**: Apache-2.0

